generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

enum TripStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum TripItemKind {
  FLIGHT
  LODGING
  MEETING
  MEAL
  TRANSPORT
  ACTIVITY
  NOTE
  OTHER
}

enum TripItemState {
  PROPOSED
  CONFIRMED
  CANCELLED
  DISMISSED
}

enum TripItemSource {
  AI
  USER
  CALENDAR
  EMAIL
}

model User {
  id              String         @id @default(cuid())
  email           String         @unique
  name            String
  emailVerified   Boolean        @default(false) @map("email_verified")
  image           String?
  role            Role           @default(USER)
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  aiSessions      AiSession[]
  authSessions    AuthSession[]
  accounts        AuthAccount[]

  reconstructRuns ReconstructRun[]
  trips           Trip[]

  @@map("users")
}

model AiSession {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String   @map("user_id")
  prompt    String
  response  String
  model     String
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@map("ai_sessions")
}

model AuthSession {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")

  @@map("auth_sessions")
}

model AuthAccount {
  id                     String    @id @default(cuid())
  accountId              String    @map("account_id")
  providerId             String    @map("provider_id")
  user                   User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                 String    @map("user_id")
  accessToken            String?   @map("access_token")
  refreshToken           String?   @map("refresh_token")
  idToken                String?   @map("id_token")
  accessTokenExpiresAt   DateTime? @map("access_token_expires_at")
  refreshTokenExpiresAt  DateTime? @map("refresh_token_expires_at")
  scope                  String?
  password               String?
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")

  @@unique([providerId, accountId])
  @@map("auth_accounts")
}

model AuthVerification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("auth_verifications")
}

// =========================
// Reconstruction runs (audit)
// =========================

enum ReconstructStatus {
  SUCCESS
  FAILED
}

enum PendingActionIntent {
  UPDATE
  CANCEL
  REPLACE
  UNKNOWN
}

model ReconstructRun {
  id           String            @id @default(cuid())

  user         User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String            @map("user_id")

  trip         Trip?             @relation(fields: [tripId], references: [id], onDelete: SetNull)
  tripId       String?           @map("trip_id")

  status       ReconstructStatus @default(SUCCESS)
  errorCode    String?           @map("error_code")
  errorMessage String?           @map("error_message")

  // Client context
  timezone     String
  nowIso       String?           @map("now_iso")

  // Input
  rawText      String            @map("raw_text")

  // Snapshot of validated TripReconstruction (includes assumptions/risks/missingInfo)
  outputJson   Json?             @map("output_json")

  createdAt    DateTime          @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([tripId])
  @@map("reconstruct_runs")
}

// =========================
// Pending Actions (clarification)
// =========================

model PendingAction {
  id            String              @id @default(cuid())

  trip          Trip                @relation(fields: [tripId], references: [id], onDelete: Cascade)
  tripId        String              @map("trip_id")

  intentType    PendingActionIntent @default(UNKNOWN) @map("intent_type")
  rawUpdateText String              @map("raw_update_text")
  candidates    Json                @map("candidates")
  payload       Json?               @map("payload")

  createdAt     DateTime            @default(now()) @map("created_at")
  expiresAt     DateTime?           @map("expires_at")

  @@index([tripId, createdAt])
  @@map("pending_actions")
}

// =========================
// Trips (persistent container)
// =========================

model Trip {
  id        String     @id @default(cuid())

  userId    String     @map("user_id")
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  title     String
  status    TripStatus @default(DRAFT)

  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  runs      ReconstructRun[]
  pendingActions PendingAction[]
  items     TripItem[]

  @@index([userId, createdAt])
  @@map("trips")
}

// =========================
// Trip Items (canonical events)
// =========================

model TripItem {
  id             String         @id @default(cuid())

  tripId         String         @map("trip_id")
  trip           Trip           @relation(fields: [tripId], references: [id], onDelete: Cascade)

  kind           TripItemKind
  title          String

  // Canonical time fields (query/sort)
  startIso       String?        @map("start_iso")
  endIso         String?        @map("end_iso")
  timezone       String?        @map("timezone")
  startTimezone  String?        @map("start_timezone")
  endTimezone    String?        @map("end_timezone")

  // Local components (display / when iso is null)
  startLocalDate String?        @map("start_local_date")
  startLocalTime String?        @map("start_local_time")
  endLocalDate   String?        @map("end_local_date")
  endLocalTime   String?        @map("end_local_time")

  locationText   String?        @map("location_text")

  // Trust primitives for UI
  isInferred      Boolean       @default(false) @map("is_inferred")
  confidence      Float         @default(0.0)
  sourceSnippet   String?       @map("source_snippet")

  // Workflow
  state          TripItemState  @default(PROPOSED)
  source         TripItemSource @default(AI)

  // Deterministic identity across runs
  fingerprint    String         @map("fingerprint")

  // Flexible, heterogeneous, optional fields:
  // - flight airline/number, PNR, airports
  // - hotel confirmation, address
  // - meeting attendees/link
  // - lat/lng + precision + source
  // - external IDs (google event id)
  // - item-specific notes
  metadata       Json?          @map("metadata")

  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  @@index([tripId, updatedAt])
  @@unique([tripId, fingerprint])
  @@map("trip_items")
}
